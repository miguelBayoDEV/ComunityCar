{% extends 'base.html.twig' %}

{% block title %}Perfil{% endblock %}

{% block body %}

    {# Añadir nuevo vehículo para vender #}
    <button><a href="/vehiculo/new">Introducir vehículo a vender</a></button>

    <h1 id="datosPersonales">Datos personales:</h1>

    <div id="avatar">
        {{ form_start(avatarForm) }}
            {% if user.avatar != null %}
                <img src="/avatar/{{ user.avatar }}" width="250px" height="250px" />
            {% else %}
                <p>No ha introducido su avatar</p>
            {% endif %}
            {{ form_row(avatarForm.avatar) }}
            <button type="submit" class="btn">Modificar</button>
        {{ form_end(avatarForm) }}
    </div>

    <div id="nombreDiv">
        <label for="nombre">Nombre:</label>
        {% if user.nombre != null or user.nombre != "" %}
            <input type="text" id="nombre" name="nombre" value="{{ user.nombre }}" id="nombre" />
        {% else %}
            <input type="text" id="nombre" name="nombre" value="" placeholder="Rellenar nombre" id="nombre" />
        {% endif %}
        <button onClick="modificar('nombre')">Modificar</button>
    </div>

    <div id="primerApellidoDiv">
        <label for="primerApellido">Primer apellido:</label>
        {% if user.primerApellido != null or user.primerApellido != "" %}
            <input type="text" id="primerApellido" name="primerApellido" value="{{ user.primerApellido }}" id="primerApellido" />
        {% else %}
            <input type="text" id="primerApellido" name="primerApellido" value="" placeholder="Rellenar primer apellido" id="primerApellido" />
        {% endif %}
        <button onClick="modificar('primerApellido')">Modificar</button>
    </div>

    <div id="segundoApellidoDiv">
        <label for="segundoApellido">Segundo apellido:</label>
        {% if user.segundoApellido != null or user.segundoApellido != "" %}
            <input type="text" id="segundoApellido" name="segundoApellido" value="{{ user.segundoApellido }}" id="segundoApellido" />
        {% else %}
            <input type="text" id="segundoApellido" name="segundoApellido" value="" placeholder="Rellenar segundo apellido" id="segundoApellido" />
        {% endif %}
        <button onClick="modificar('segundoApellido')">Modificar</button>
    </div>

    <div id="nickDiv">
        <label for="nick">Nick:</label>
        {% if user.nick != null or user.nick != "" %}
            <input type="text" id="nick" name="nick" value="{{ user.nick }}" id="nick" />
        {% else %}
            <input type="text" id="nick" name="nick" value="" placeholder="Rellenar nick" id="nick" />
        {% endif %}
        <button onClick="modificar('nick')">Modificar</button>
    </div>

    <div id="localidadDiv">
        <label for="localidad">Localidad:</label>
        {% if user.localidad != null or user.localidad != "" %}
            <input type="text" id="localidad" name="localidad" value="{{ user.localidad }}" id="localidad" />
        {% else %}
            <input type="text" id="localidad" name="localidad" value="" placeholder="Rellenar localidad" id="localidad" />
        {% endif %}
        <button onClick="modificar('localidad')">Modificar</button>
    </div>

    <div id="provinciaDiv">
        <label for="provincia">Provincia:</label>
        {% if user.provincia != null or user.provincia != "" %}
            <input type="text" id="provincia" name="provincia" value="{{ user.provincia }}" id="provincia" />
        {% else %}
            <input type="text" id="provincia" name="provincia" value="" placeholder="Rellenar provincia" id="provincia" />
        {% endif %}
        <button onClick="modificar('provincia')">Modificar</button>
    </div>

    <div id="telefonoMovilDiv">
        <label for="telefonoMovil">Teléfono móvil:</label>
        {% if user.telefonoMovil != null or user.telefonoMovil != "" %}
            <input type="tel" id="telefonoMovil" name="telefonoMovil" value="{{ user.telefonoMovil }}" pattern="[0-9]{9}" id="telefonoMovil" />
        {% else %}
            <input type="tel" id="telefonoMovil" name="telefonoMovil" value="" placeholder="123456789" pattern="[0-9]{9}" id="telefonoMovil" />
        {% endif %}
        <button onClick="modificar('telefonoMovil')">Modificar</button>
    </div>

    <h1>Lista de vehículos mios:</h1>
    {% for vehiculo in user.vehiculos %}
        {% if vehiculo.eliminado != true %}
            <div class="vehicles">
                Marca: {{ vehiculo.marca }}
                <br/>
                Modelo: {{ vehiculo.modelo }}
                <br/>
                Precio: {{ vehiculo.precio }} euros.
                <br/>
                {% if vehiculo.venta == false %}
                    <button onClick="addBuscador({{ vehiculo.id }});">Añadir a venta</button>
                {% endif %}
            </div>
        {% endif %}
    {% endfor %}

    <h1>Lista de vehículos en venta:</h1>
    {% for vehiculo in user.vehiculos %}
        {% if vehiculo.venta == true and vehiculo.eliminado == false %}
            <div class="vehicles">
                Marca: {{ vehiculo.marca }}
                <br/>
                Modelo: {{ vehiculo.modelo }}
                <br/>
                Descripción: {{ vehiculo.descripcion }}
                <br/>
                Precio: {{ vehiculo.precio }} euros.
                <br/>
                <button onClick="eliminarBuscador({{ vehiculo.id }});">Eliminar de venta</button>
            </div>
        {% endif %}
    {% endfor %}

    <script>
        function modificar(id) {

            // Validar dato antes de enviar al servidor
            var comprobar = true;
            var dato = $("#"+id).val();
            if(id == "nombre") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == false) {
                    alert("El nombre introducido es incorrecto.");
                    window.location.reload();
                    if(dato != null) {
                        $("#nombre").prop('value', "{{user.nombre}}");
                    }
                    comprobar = false;
                }
            }else if(id == "primerApellido") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == false) {
                    alert("El primer apellido introducido es incorrecto.");
                    window.location.reload();
                    if(dato != null) {
                        $("#primerApellido").prop('value', "{{user.primerApellido}}");
                    }
                    comprobar = false;
                }
            }else if(id == "segundoApellido") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == false) {
                    alert("El segundo apellido introducido es incorrecto.");
                    if(dato != null) {
                        $("#segundoApellido").prop('value', "{{user.segundoApellido}}");
                    }
                    comprobar = false;
                }
            }else if(id == "nick") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == false) {
                    alert("El nick introducido es incorrecto.");
                    window.location.reload();
                    if(dato != null) {
                        $("#nick").prop('value', "{{user.nick}}");
                    }
                    comprobar = false;
                }
            }else if(id == "localidad") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == false) {
                    alert("El localidad introducida es incorrecto.");
                    if(dato != null) {
                        $("#localidad").prop('value', "{{user.localidad}}");
                    }
                    comprobar = false;
                }
            }else if(id == "provincia") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == false) {
                    alert("El provincia introducida es incorrecto.");
                    if(dato != null) {
                        $("#provincia").prop('value', "{{user.provincia}}");
                    }
                    comprobar = false;
                }
            }else if(id == "telefonoMovil") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == true) {
                    alert("El teléfono móvil introducido es incorrecto.");
                    if(dato != null) {
                        $("#telefonoMovil").prop('value', "{{user.telefonoMovil}}");
                    }
                    comprobar = false;
                }
            }

            var datos = {
                'dato':dato,
                'condicion':id
            };

            function fail(data) {
                alert("Error de AJAX: " + data);
            }

            if(comprobar == true) {
                $.ajax({
                    type: "GET",
                    url: "/modificar",
                    data: datos,
                    success: function(data) {
                        window.location.reload();
                    },
                    error: fail
                });
            }
        }

        function eliminarBuscador(id) {

            function fail(data) {
                alert("Error de AJAX: " + data);
            }

            $.ajax({
                type: "GET",
                url: "/eliminarVehiculoBuscador",
                data: {'id_vehiculo': id},
                success: function(data) {
                    if(data == "1") {
                        alert("Vehiculo eliminado correctamente del buscador y en venta.");
                        window.location.reload();
                    }
                },
                error: fail
            });
        }

        function addBuscador(id) {
            function fail(data) {
                alert("Error de AJAX: " + data);
            }

            $.ajax({
                type: "GET",
                url: "/addVehiculoBuscador",
                data: {'id_vehiculo': id},
                success: function(data) {
                    if(data == "1") {
                        alert("Vehiculo añadido correctamente del buscador y en venta.");
                        window.location.reload();
                    }
                },
                error: fail
            });
        }
    </script>
{% endblock %}