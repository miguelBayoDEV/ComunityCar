{% extends 'base.html.twig' %}

{% block title %}Perfil{% endblock %}

{% block body %}
    <div class="row mt-5">
        <div class="col-lg-1 col-md-2 col-sm-0 col-xs-0"></div>
        <div class="col-lg-10 col-md-8 col-sm-0 col-xs-0 d-flex justify-content-center">
            <a class="mr-3" href="/vehiculo/new"><img src="/comunes/icon/anadir.png" width="50px" height="50px" data-toggle="tooltip" title="Crear anuncio vehículo" /></a>
        </div>
        <div class="col-lg-1 col-md-2 col-sm-0 col-xs-0"></div>
    </div>

    <div class="row d-flex justify-content-center mt-5 mb-5 exportar">
        <div class="col-lg-6 col-md-0 col-sm-0 col-xs-0">
            <h3 class="pb-5 text-center">Perfil usuario:</h3>
            <div class="d-flex align-items-start">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <a class="nav-link active" id="v-pills-perfil-tab" data-toggle="pill" href="#v-pills-perfil" role="tab" aria-controls="v-pills-perfil" aria-selected="true">Perfil personal</a>
                    <a class="nav-link" id="v-pills-vehiculosMios-tab" data-toggle="pill" href="#v-pills-vehiculosMios" role="tab" aria-controls="v-pills-vehiculosMios" aria-selected="false">Vehículos propios</a>
                    <a class="nav-link" id="v-pills-vehiculosVenta-tab" data-toggle="pill" href="#v-pills-vehiculosVenta" role="tab" aria-controls="v-pills-vehiculosVenta" aria-selected="true">Vehículos en venta</a>
                </div>
                <div class="tab-content pildora-content pl-4" id="v-pills-tabContent">
                    <div class="tab-pane fade show active" id="v-pills-perfil" role="tabpanel" aria-labelledby="v-pills-perfil-tab">
                        <div class="perfil pildora-border pl-1 pt-1 pr-2 d-flex flex-column">
                            <div id="avatar">
                                {{ form_start(avatarForm) }}
                                    {% if user.avatar != null %}
                                        <div class="d-flex justify-content-center">
                                            <img src="/avatar/{{ user.avatar }}" width="150px" height="150px" class="round" />
                                        </div>
                                    {% else %}
                                        <div class="d-flex justify-content-center">
                                            <p>No ha introducido su avatar</p>
                                        </div>
                                    {% endif %}
                                    {{ form_row(avatarForm.avatar) }}
                                    <div class="d-flex justify-content-center">
                                        <button type="submit" class="btn">Modificar</button>
                                    </div>
                                {{ form_end(avatarForm) }}
                            </div>

                            <div id="nombreDiv">
                                <label for="nombre">Nombre:</label>
                                {% if user.nombre != null or user.nombre != "" %}
                                    <input type="text" id="nombre" name="nombre" value="{{ user.nombre }}" id="nombre" />
                                {% else %}
                                    <input type="text" id="nombre" name="nombre" value="" placeholder="Rellenar nombre" id="nombre" />
                                {% endif %}
                                <button class="btn" onClick="modificar('nombre')">Modificar</button>
                            </div>

                            <div id="primerApellidoDiv">
                                <label for="primerApellido">Primer apellido:</label>
                                {% if user.primerApellido != null or user.primerApellido != "" %}
                                    <input type="text" id="primerApellido" name="primerApellido" value="{{ user.primerApellido }}" id="primerApellido" />
                                {% else %}
                                    <input type="text" id="primerApellido" name="primerApellido" value="" placeholder="Rellenar primer apellido" id="primerApellido" />
                                {% endif %}
                                <button class="btn" onClick="modificar('primerApellido')">Modificar</button>
                            </div>

                            <div id="segundoApellidoDiv">
                                <label for="segundoApellido">Segundo apellido:</label>
                                {% if user.segundoApellido != null or user.segundoApellido != "" %}
                                    <input type="text" id="segundoApellido" name="segundoApellido" value="{{ user.segundoApellido }}" id="segundoApellido" />
                                {% else %}
                                    <input type="text" id="segundoApellido" name="segundoApellido" value="" placeholder="Rellenar segundo apellido" id="segundoApellido" />
                                {% endif %}
                                <button class="btn" onClick="modificar('segundoApellido')">Modificar</button>
                            </div>

                            <div id="nickDiv">
                                <label for="nick">Nick:</label>
                                {% if user.nick != null or user.nick != "" %}
                                    <input type="text" id="nick" name="nick" value="{{ user.nick }}" id="nick" />
                                {% else %}
                                    <input type="text" id="nick" name="nick" value="" placeholder="Rellenar nick" id="nick" />
                                {% endif %}
                                <button class="btn" onClick="modificar('nick')">Modificar</button>
                            </div>

                            <div id="localidadDiv">
                                <label for="localidad">Localidad:</label>
                                {% if user.localidad != null or user.localidad != "" %}
                                    <input type="text" id="localidad" name="localidad" value="{{ user.localidad }}" id="localidad" />
                                {% else %}
                                    <input type="text" id="localidad" name="localidad" value="" placeholder="Rellenar localidad" id="localidad" />
                                {% endif %}
                                <button class="btn" onClick="modificar('localidad')">Modificar</button>
                            </div>

                            <div id="provinciaDiv">
                                <label for="provincia">Provincia:</label>
                                {% if user.provincia != null or user.provincia != "" %}
                                    <input type="text" id="provincia" name="provincia" value="{{ user.provincia }}" id="provincia" />
                                {% else %}
                                    <input type="text" id="provincia" name="provincia" value="" placeholder="Rellenar provincia" id="provincia" />
                                {% endif %}
                                <button class="btn" onClick="modificar('provincia')">Modificar</button>
                            </div>

                            <div id="telefonoMovilDiv">
                                <label for="telefonoMovil">Teléfono móvil:</label>
                                {% if user.telefonoMovil != null or user.telefonoMovil != "" %}
                                    <input type="tel" id="telefonoMovil" name="telefonoMovil" value="{{ user.telefonoMovil }}" pattern="[0-9]{9}" id="telefonoMovil" />
                                {% else %}
                                    <input type="tel" id="telefonoMovil" name="telefonoMovil" value="" placeholder="123456789" pattern="[0-9]{9}" id="telefonoMovil" />
                                {% endif %}
                                <button class="btn" onClick="modificar('telefonoMovil')">Modificar</button>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="v-pills-vehiculosMios" role="tabpanel" aria-labelledby="v-pills-vehiculosMios-tab">
                        <div class="vehiculosMios">
                            {% for vehiculo in user.vehiculos %}
                                {% if vehiculo.eliminado != true %}
                                    <div class="vehicles pildora-border mb-3 pl-1 pt-1 pr-2 d-flex justify-content-between">
                                        <div class="d-flex flex-column pl-3">
                                            <p>Marca: {{ vehiculo.marca }} - Modelo: {{ vehiculo.modelo }}</p>
                                            <p>Precio: <strong>{{ vehiculo.precio }}</strong> euros.</p>
                                        </div>
                                        {% if vehiculo.venta == false %}
                                            <button class="btn" onClick="addBuscador({{ vehiculo.id }});">Añadir a venta</button>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <div class="tab-pane fade" id="v-pills-vehiculosVenta" role="tabpanel" aria-labelledby="v-pills-vehiculosVenta-tab">
                        <div class="vehiculosVenta">
                            {% for vehiculo in user.vehiculos %}
                                {% if vehiculo.venta == true and vehiculo.eliminado == false %}
                                    <div class="vehicles">
                                        <div class="vehicles pildora-border mb-3 pl-1 pt-1 pr-2 d-flex justify-content-between">
                                            <div class="d-flex flex-column pl-3">
                                                <p>Marca: {{ vehiculo.marca }} - Modelo: {{ vehiculo.modelo }}</p>
                                                <p>Precio: <strong>{{ vehiculo.precio }}</strong> euros.</p>
                                            </div>
                                            <button class="btn" onClick="eliminarBuscador({{ vehiculo.id }});">Eliminar de venta</button>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function modificar(id) {

            // Validar dato antes de enviar al servidor
            var comprobar = true;
            var dato = $("#"+id).val();
            if(id == "nombre") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == false) {
                    alert("El nombre introducido es incorrecto.");
                    window.location.reload();
                    if(dato != null) {
                        $("#nombre").prop('value', "{{user.nombre}}");
                    }
                    comprobar = false;
                }
            }else if(id == "primerApellido") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == false) {
                    alert("El primer apellido introducido es incorrecto.");
                    window.location.reload();
                    if(dato != null) {
                        $("#primerApellido").prop('value', "{{user.primerApellido}}");
                    }
                    comprobar = false;
                }
            }else if(id == "segundoApellido") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == false) {
                    alert("El segundo apellido introducido es incorrecto.");
                    if(dato != null) {
                        $("#segundoApellido").prop('value', "{{user.segundoApellido}}");
                    }
                    comprobar = false;
                }
            }else if(id == "nick") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == false) {
                    alert("El nick introducido es incorrecto.");
                    window.location.reload();
                    if(dato != null) {
                        $("#nick").prop('value', "{{user.nick}}");
                    }
                    comprobar = false;
                }
            }else if(id == "localidad") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == false) {
                    alert("El localidad introducida es incorrecto.");
                    if(dato != null) {
                        $("#localidad").prop('value', "{{user.localidad}}");
                    }
                    comprobar = false;
                }
            }else if(id == "provincia") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == false) {
                    alert("El provincia introducida es incorrecto.");
                    if(dato != null) {
                        $("#provincia").prop('value', "{{user.provincia}}");
                    }
                    comprobar = false;
                }
            }else if(id == "telefonoMovil") {
                if(dato.length == 0 && dato == "" || dato == null || dato == undefined || isNaN(dato) == true) {
                    alert("El teléfono móvil introducido es incorrecto.");
                    if(dato != null) {
                        $("#telefonoMovil").prop('value', "{{user.telefonoMovil}}");
                    }
                    comprobar = false;
                }
            }

            var datos = {
                'dato':dato,
                'condicion':id
            };

            function fail(data) {
                alert("Error de AJAX: " + data);
            }

            if(comprobar == true) {
                $.ajax({
                    type: "GET",
                    url: "/modificar",
                    data: datos,
                    success: function(data) {
                        window.location.reload();
                    },
                    error: fail
                });
            }
        }

        function eliminarBuscador(id) {

            function fail(data) {
                alert("Error de AJAX: " + data);
            }

            $.ajax({
                type: "GET",
                url: "/eliminarVehiculoBuscador",
                data: {'id_vehiculo': id},
                success: function(data) {
                    if(data == "1") {
                        alert("Vehiculo eliminado correctamente del buscador y en venta.");
                        window.location.reload();
                    }
                },
                error: fail
            });
        }

        function addBuscador(id) {
            function fail(data) {
                alert("Error de AJAX: " + data);
            }

            $.ajax({
                type: "GET",
                url: "/addVehiculoBuscador",
                data: {'id_vehiculo': id},
                success: function(data) {
                    if(data == "1") {
                        alert("Vehiculo añadido correctamente del buscador y en venta.");
                        window.location.reload();
                    }
                },
                error: fail
            });
        }
    </script>
{% endblock %}