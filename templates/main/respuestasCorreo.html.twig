{% extends 'base.html.twig' %}

{% block title %}Respuestas Correo{% endblock %}

{% block body %}
    <div class="row">
        <div class="col-12 mensaje">
            <div class="row mt-5">
                <div class="col">
                    <div class="text-center">
                        <h2>Mensaje:</h2>
                        <p>Texto: {{message.texto}}</p>
                    </div>
                </div>
            </div>

            <hr class="bg-dark" />

            <div class="row mt-5">
                <div class="col-4"></div>
                <div class="col-4 d-flex align-self-center justify-content-center">
                    <button><a href="/respuesta/new/{{ message.id }}">Responder</a></button>
                    {% if message.reportado == true and is_granted("ROLE_ADMIN") %}
                        <button onClick="eliminar({{ message.id }}, {{message.vehiculoMessage.id}});">Eliminar</button>
                    {% endif %}
                    {% if message.oculto == false %}
                        {% if message.vehiculoMessage.propietario.email == app.user.email %}
                            <button onClick="comprar({{ message.id }}, {{message.vehiculoMessage.id}});">Comprar</button>
                        {% endif %}
                    {% endif %}

                    {% if message.reportado == false %}
                        <button onClick="reportar({{ message.id }});">Reportar</button>
                    {% endif %}
                </div>
                <div class="col-4"></div>
            </div>

            <div class="row mt-5">
                <div class="col">
                    {% for respuesta in message.respuestas %}
                        {% if app.user.email == respuesta.autor %}
                            <div class="text-left">
                                {% if emisor.email == respuesta.autor %}
                                    {% if emisor.avatar != null %}
                                        <img src="/avatar/{{ emisor.avatar }}" width="5%" height="5%" />
                                    {% endif %}
                                {% elseif receptor.email == respuesta.autor %}
                                    {% if receptor.avatar != null %}
                                        <img src="/avatar/{{ receptor.avatar }}" width="5%" height="5%" />
                                    {% endif %}
                                {% endif %}
                                {{ respuesta.texto }}
                                {{ respuesta.fecha|date("Y-m-d") }}
                                {{ respuesta.autor }}
                            </div>
                        {% elseif app.user.email != respuesta.autor  %}
                            <div class="text-right">
                                {% if emisor.email == respuesta.autor %}
                                    {% if emisor.avatar != null %}
                                        <img src="/avatar/{{ emisor.avatar }}" width="5%" height="5%" />
                                    {% endif %}
                                {% elseif emisor.email == respuesta.autor %}
                                    {% if receptor.avatar != null %}
                                        <img src="/avatar/{{ receptor.avatar }}" width="5%" height="5%" />
                                    {% endif %}
                                {% endif %}
                                {{ respuesta.texto }}
                                {{ respuesta.fecha|date("Y-m-d") }}
                                {{ respuesta.autor }}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
        function reportar(message) {

            function fail(data) {
                alert("Error de AJAX: " + data);
            }

            $.ajax({
                type: "GET",
                url: "/reportarMensajeVehiculo",
                data: {'mensaje':message},
                success: function(data) {
                    if(data == "1") {
                        alert("Mensaje reportado correctamente.");
                        window.location.reload();
                    }
                },
                error: fail
            });
        }

        function eliminar(message, vehicle) {

            var datos = {
                'mensaje':message,
                'vehiculo':vehicle
            };

            function fail(data) {
                alert("Error de AJAX: " + data);
            }

            $.ajax({
                type: "GET",
                url: "/eliminarMensajeVehiculo",
                data: datos,
                success: function(data) {
                    if(data == "1") {
                        alert("Mensaje y veh√≠culo eliminados correctamente debido a que se ha comprobado el reporte.");
                        window.location.reload();
                    }
                },
                error: fail
            });
        }

        function comprar(message, vehicle) {

            var datos = {
                'mensaje':message,
                'vehiculo':vehicle
            };

            function fail(data) {
                alert("Error de AJAX: " + data);
            }

            $.ajax({
                type: "GET",
                url: "/comprarVehiculo",
                data: datos,
                success: function(data) {
                    if(data == "1") {
                        alert("Vehiculo comprado correctamente y mensajes ocultados junto al buscador.");
                        window.location.reload();
                    }
                },
                error: fail
            });
        }
    </script>

{% endblock %}