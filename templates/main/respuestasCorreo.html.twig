{% extends 'base.html.twig' %}

{% block title %}Respuestas Correo{% endblock %}

{% block body %}
    <div class="row">
        <div class="col-lg-12 col-md-0 col-sm-0 col-xs-0 mensaje">
            <div class="row mt-5">
                <div class="col-lg-12 col-md-0 col-sm-0 col-xs-0">
                    <div class="text-center">
                        <h2>Mensaje:</h2>
                        <p>Texto: {{message.texto}}</p>
                    </div>
                </div>
            </div>

            <hr class="bg-dark" />

            <div class="row mt-5">
                <div class="col-lg-1 col-md-2 col-sm-0 col-xs-0"></div>
                <div class="col-lg-10 col-md-8 col-sm-0 col-xs-0 d-flex justify-content-center">
                    <button class="btn btn-info mr-3"><a href="/respuesta/new/{{ message.id }}"><img src="" /></a></button>
                    {% if message.reportado == true and is_granted("ROLE_ADMIN") %}
                        <button class="btn btn-info mr-3" onClick="eliminar({{ message.id }}, {{message.vehiculoMessage.id}});">Eliminar</button>
                    {% endif %}
                    {% if message.oculto == false %}
                        {% if message.vehiculoMessage.propietario.email == app.user.email %}
                            <button class="btn btn-info mr-3" onClick="comprar({{ message.id }}, {{message.vehiculoMessage.id}});">Comprar</button>
                        {% endif %}
                    {% endif %}

                    {% if message.reportado == false %}
                        <button class="btn btn-info mr-3" onClick="reportar({{ message.id }});">Reportar</button>
                    {% endif %}
                </div>
                <div class="col-lg-1 col-md-2 col-sm-0 col-xs-0"></div>
            </div>

            <div class="row mt-5">
                <div class="col-lg-6 col-md-2 col-sm-0 col-xs-0">
                    {% for respuesta in message.respuestas %}
                        {% if app.user.email == respuesta.autor %}
                            <div class="text-left d-flex mb-3">
                                {% if emisor.email == respuesta.autor %}
                                    {% if emisor.avatar != null %}
                                        <img src="/avatar/{{ emisor.avatar }}" width="70px" height="70px" class="round" />
                                    {% endif %}
                                {% elseif receptor.email == respuesta.autor %}
                                    {% if receptor.avatar != null %}
                                        <img src="/avatar/{{ receptor.avatar }}" width="70px" height="70px" class="round" />
                                    {% endif %}
                                {% endif %}
                                <div class="d-flex flex-column border border-dark bg-white ml-2 p-2">
                                    <div>
                                        {{ respuesta.texto }}
                                    </div>
                                    <div>
                                        {{ respuesta.fecha|date("Y-m-d") }}
                                        {{ respuesta.autor }}
                                    </div>
                                </div>
                            </div>
                        {% elseif app.user.email != respuesta.autor  %}
                            <div class="text-right d-flex">
                                {% if emisor.email == respuesta.autor %}
                                    {% if emisor.avatar != null %}
                                        <img src="/avatar/{{ emisor.avatar }}" width="70px" height="70px" class="round" />
                                    {% endif %}
                                {% elseif emisor.email == respuesta.autor %}
                                    {% if receptor.avatar != null %}
                                        <img src="/avatar/{{ receptor.avatar }}" width="70px" height="70px" class="round" />
                                    {% endif %}
                                {% endif %}
                                <div class="d-flex flex-column border border-dark bg-success ml-2 p-2">
                                    <div>
                                        {{ respuesta.texto }}
                                    </div>
                                    <div>
                                        {{ respuesta.fecha|date("Y-m-d") }}
                                        {{ respuesta.autor }}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
        function reportar(message) {

            function fail(data) {
                alert("Error de AJAX: " + data);
            }

            $.ajax({
                type: "GET",
                url: "/reportarMensajeVehiculo",
                data: {'mensaje':message},
                success: function(data) {
                    if(data == "1") {
                        alert("Mensaje reportado correctamente.");
                        window.location.reload();
                    }
                },
                error: fail
            });
        }

        function eliminar(message, vehicle) {

            var datos = {
                'mensaje':message,
                'vehiculo':vehicle
            };

            function fail(data) {
                alert("Error de AJAX: " + data);
            }

            $.ajax({
                type: "GET",
                url: "/eliminarMensajeVehiculo",
                data: datos,
                success: function(data) {
                    if(data == "1") {
                        alert("Mensaje y veh√≠culo eliminados correctamente debido a que se ha comprobado el reporte.");
                        window.location.reload();
                    }
                },
                error: fail
            });
        }

        function comprar(message, vehicle) {

            var datos = {
                'mensaje':message,
                'vehiculo':vehicle
            };

            function fail(data) {
                alert("Error de AJAX: " + data);
            }

            $.ajax({
                type: "GET",
                url: "/comprarVehiculo",
                data: datos,
                success: function(data) {
                    if(data == "1") {
                        alert("Vehiculo comprado correctamente y mensajes ocultados junto al buscador.");
                        window.location.reload();
                    }
                },
                error: fail
            });
        }
    </script>

{% endblock %}